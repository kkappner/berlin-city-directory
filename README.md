# Replication files and code for Albers and Kappner (2021)

This repository contains replication code for Albers and Kappner (2021).

Trained OCR model (Calamari)
Documentation of OCR output parsing (Python)
Documentation of referencing (Python)
Documentation of paper replication files (Stata)

## OCR output parsing

The script takes in a collection of [PAGE XML](https://www.primaresearch.org/schema/PAGE/gts/pagecontent/2019-07-15/Simple%20PAGE%20XML%20Example.pdf) files generated by [OCR4all](https://github.com/OCR4all/OCR4all) or a similar OCR environment. The 'bab_h_1880' directory in this repository contains a sample of 10 OCR'd pages from the [1880 Berlin city directory](https://digital.zlb.de/viewer/image/34115512_1880/1141/).

```python
from cd_datastructure import CDBook

#Generate a city directory book instance
cdbook = CDBook()

#Parse PAGE XML files, iteratively adding them to the CDBook.
for filename in os.listdir('bab_h_1880'):
    infile_xml = os.path.join('bab_h_1880', filename)
    cdbook.parse_from_pagexml(infile_xml)
```
A CDBook is a dataclass structuring the OCR output.
```python
>>> cdbook
CDBook [10 pages, 60 columns, 5869 lines]
>>> cdbook.pages[0].columns[0].lines[1]
1. a. d. Linienſtr.
```
To structure the OCR'd text content, identify lines that announce street names and street numbers, then tag and consolidate indented lines. These operations are performed at the column level because the underlying functions exploit statistics computed over all bounding boxes within a given column. Passing a list of expected street names, e.g. from [here](https://digital.zlb.de/viewer/image/34115512_1880/1840/LOG_0148/), helps to identify lines announcing street names more reliably.
```python
street_list = ['Ackerſtraße', 'Adalbertſtraße', 'Adlerſtraße', 'Admiralſtraße', 'Adolfſtraße', 'Ahornſtraße', 
               'Albrechtſtraße', 'Alexanderſtraße', 'Kleine Alexanderſtraße', 'Alexander Ufer', 'Alexandrinenſtraße']
               
for page in cdbook.pages:
    for col in page.columns:
        col.find_lines_with_street_names(inflate_std=3, street_list=street_list, difflib_cutoff=.75)
        col.find_lines_with_street_numbers()
        col.tag_indented_lines(inflate_std=.5, ignore_nonstd_lines=True)
        col.consolidate_indented_lines()
```
The algorithm did a reasonable job, though it failed to identify [Albrechtſtraße](https://digital.zlb.de/viewer/image/34115512_1880/1147/). If needed, this can be corrected manually, either by passing the desired string or by searching for a close match with a lower treshhold.
```python
>>> cdbook.list_streets()
Page | Column | Line | Street
0      0        0      Ackerſtraße
3      2        9      Adalbertſtraße
5      4        19     Adlerſtraße
5      5        40     Admiralſtraße
6      4        50     Adolfſtraße
6      5        28     Ahornſtraße
7      2        28     Alexanderſtraße
9      0        8      Kleine Alexanderſtraße
9      3        54     Alexander Ufer
9      3        57     Alexandrinenſtraße

cdbook.pages[6].columns[5].lines[30]
>>> Albrechtſtr. (NW)
cdbook.pages[6].columns[5].lines[30].tag_as_street_name(street_list=street_list, difflib_cutoff=.5)
cdbook.pages[6].columns[5].lines[30].tag_as_street_name(name='Albrechtſtraße')
```
Next, the recognized street names and house numbers are distributed across all other lines. The following example output from [the third column of page 9](https://digital.zlb.de/viewer/image/34115512_1880/1149/) also illustrates that a couple of lines were accidentally consolidated.
```python
cdbook.distribute_addresses()
cdbook.pages[8].columns[2].list_entries()
>>> List of entries in column
>>> 0 Alexanderſtraße 38a  Silberberg & Co., Gebr., Fbrk. 
>>> 1 Alexanderſtraße 39  E. Dietert, Ww, Rent Caro, Kfm. Färber, Seifenſieder. Hirſch, Kfm. 
>>> 2 Alexanderſtraße 39  Jacob, Fbrk. Köttner, Kim. 
>>> 3 Alexanderſtraße 39  Landgraf, Kfm. 
>>> 4 Alexanderſtraße 39  Steinauer & Co., Strumpfwrn. Geſch. 
>>> 5 Alexanderſtraße 39  Wuttke, Ger. Aktuar a. D. 
>>> 6 Alexanderſtraße 40  E. Quarg, Reſtaur. Feuermeldeſtelle. 
>>> ...
```

To structure the content *within* each text line, an adapted version of the [city-directory-entry-parser](https://github.com/nypl-spacetime/city-directory-entry-parser) is used. This is based ond a conditional random fields algorithm trained with customized ground truth data.

```python
from cd_entryparsing import Classifier

training_data_csv = os.path.join(path_training, 'training_ab1873_p4u25v2.csv')

#Create a classifier for entry parsing
classifier = Classifier()
classifier.load_training(training_data_csv)
classifier.train()
cdbook.parse_all_entries(classifier)
```

The algorithm parses line content into names, occupations, proprietory status indicators, absentee addresses and other information. For the example output above, all occupations are correctly detected, though some non-occupation tokens are wrongly labeled as occupations:

```
>>> recognized_occupations = []
>>> for line in cdbook.pages[8].columns[2].lines:
>>>     line.parsed_entry.categories['occupations']
>>>     recognized_occupations.extend(line.parsed_entry.categories['occupations'])
>>> recognized_occupations[:15]
['Co', 'Gebr .', 'Fbrk .', 'Ww', 'Rent', 'Kfm .', 'Seifenſieder .', 'Kfm .', 'Fbrk .', 'Kim .', 'Kfm .', 'Co', 'Strumpfwrn . Geſch .', 'Ger. Aktuar a. D.', 'Reſtaur . Feuermeldeſtelle .']
```
To prepare the structured data, we convert it into a DataFrame, dropping all non-address and non-occupation information, and sanitizing the strings.

```python
>>> df = cdbook.occupations_to_dataframe(sanitize_strings=True)
>>> df
                  street number        occupation
0            Ackerſtraße                         
1            Ackerſtraße      1         Poſtbeamt
2            Ackerſtraße      1               Kfm
3            Ackerſtraße      1         Schneider
4            Ackerſtraße      1               Kfm
                 ...    ...               ...
5232  Alexandrinenſtraße    18a                Ww
5233  Alexandrinenſtraße    18a       Schneiderin
5234  Alexandrinenſtraße     19  Baugeſell⸗ſchaft
5235  Alexandrinenſtraße     19         Stadtſerg
5236  Alexandrinenſtraße     19         Schloſſer

[5237 rows x 3 columns]
```

## Geo- and status-referencing
